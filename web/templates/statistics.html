{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>Site Statistics</h1>
            <p class="lead">Insights into how developers are using Code Thesaurus.</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card mb-4 shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Overall Activity</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <h2 class="display-4">{{ total_visits }}</h2>
                            <p class="text-muted">Total Visits</p>
                        </div>
                        <div class="col-6">
                            <h2 class="display-4">{{ total_lookups }}</h2>
                            <p class="text-muted">Total Lookups</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6 border-end">
                            <h4 class="mb-0">{{ unique_comparisons_count }}</h4>
                            <small class="text-muted">Unique Lang Comparisons</small>
                        </div>
                        <div class="col-6">
                            <h4 class="mb-0">{{ unique_structures_count }}</h4>
                            <small class="text-muted">Unique Category Lookups</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card mb-4 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Language Popularity</h5>
                </div>
                <div class="card-body">
                    <canvas id="languagesChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Most Popular Specific Concept Lookups</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Comparing how often specific concepts are looked up for each language (e.g., "Javascript functions").</p>
                    <canvas id="conceptLangsChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Lookups</h5>
                </div>
                <div class="card-body">
                    {% if recent_lookups %}
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Language 1</th>
                                <th>Language 2</th>
                                <th>Concept</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lookup in recent_lookups %}
                            <tr>
                                <td>{{ lookup.date_time|date:"Y-m-d H:i" }}</td>
                                <td>{{ lookup.lang1 }}</td>
                                <td>{% if lookup.lang2 %}{{ lookup.lang2 }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                <td>{{ lookup.structure }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center">No recent lookups recorded.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exchange-alt"></i> Top Comparisons</h5>
                </div>
                <div class="card-body">
                    {% if popular_comparisons %}
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Language 1</th>
                                <th>Language 2</th>
                                <th class="text-end">Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comp in popular_comparisons %}
                            <tr>
                                <td>{{ comp.lang1 }}</td>
                                <td>{{ comp.lang2 }}</td>
                                <td class="text-end">{{ comp.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center">No comparisons made yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Category Popularity</h5>
                </div>
                <div class="card-body">
                    <canvas id="structuresChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-language"></i> Most Popular Languages</h5>
                </div>
                <div class="card-body">
                    {% if popular_languages %}
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Language</th>
                                <th class="text-end">Occurrences</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lang in popular_languages %}
                            <tr>
                                <td>{{ lang.name }}</td>
                                <td class="text-end">{{ lang.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center">No data available yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-project-diagram"></i> Most Popular Concept Categories</h5>
                </div>
                <div class="card-body">
                    {% if popular_structures %}
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="text-end">Lookups</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for struct in popular_structures %}
                            <tr>
                                <td>{{ struct.name }}</td>
                                <td class="text-end">{{ struct.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-center">No data available yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const langData = {{ popular_languages_json|safe }};
        const structData = {{ popular_structures_json|safe }};
        const conceptLangData = {{ popular_concept_langs_json|safe }};

        if (langData.length > 0) {
            new Chart(document.getElementById('languagesChart'), {
                type: 'bar',
                data: {
                    labels: langData.map(item => item.name),
                    datasets: [{
                        label: 'Lookups',
                        data: langData.map(item => item.count),
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        if (structData.length > 0) {
            new Chart(document.getElementById('structuresChart'), {
                type: 'doughnut',
                data: {
                    labels: structData.map(item => item.name),
                    datasets: [{
                        data: structData.map(item => item.count),
                        backgroundColor: [
                            '#17a2b8', '#28a745', '#ffc107', '#dc3545', '#007bff',
                            '#6610f2', '#e83e8c', '#fd7e14', '#20c997', '#6c757d'
                        ]
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        if (conceptLangData.length > 0) {
            new Chart(document.getElementById('conceptLangsChart'), {
                type: 'bar',
                data: {
                    labels: conceptLangData.map(item => item.label),
                    datasets: [{
                        label: 'Lookups',
                        data: conceptLangData.map(item => item.count),
                        backgroundColor: 'rgba(52, 58, 64, 0.7)',
                        borderColor: 'rgba(52, 58, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    });
</script>
{% endblock %}
